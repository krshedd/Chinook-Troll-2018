---
title: "Summer Troll + Sport GSI Plots AY 2018"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, message=FALSE, results='hide'}
knitr::opts_chunk$set(echo = FALSE)
source("~/../R/Functions.GCL.R")
library(tidyverse)
library(lubridate)
load_objects("../Objects/")
load_objects("../Estimates objects/")
```

# Summer Troll

## Harvest

```{r summer_harvest, message=FALSE}
(summer_harvest <- read_csv("../Harvest Data/ft - Detailed Fish Tickets_traditional.csv") %>% 
  mutate(Month = month(`Date Fishing Ended`, label = TRUE, abbr = FALSE)) %>% 
  mutate(Fishery = case_when(Month %in% month.name[1:4] ~ "Late Winter",
                             Month %in% month.name[5] ~ "Spring Ret 1", 
                             Month %in% month.name[6] ~ "Spring Ret 2", 
                             Month %in% month.name[7] ~ "Summer Ret 1",
                             Month %in% month.name[8:9] ~ "Summer Ret 2",
                             Month %in% month.name[10:12] ~ "Early Winter"
                             )) %>% 
 mutate(Quadrant = case_when(District %in% c(113, 114, 116, 154, 156, 157, 181, 183, 189) ~ 171,
                             District %in% c(103, 104, 152) ~ 172,
                             District %in% c(109, 110, 111, 112, 115) ~ 173,
                             District %in% c(101, 102, 105, 106, 107, 108) ~ 174)) %>% 
  filter(Year == 2018 & Fishery %in% c("Summer Ret 1", "Summer Ret 2")) %>% 
  group_by(Quadrant, Fishery) %>% 
  summarise(Harvest = sum(`Number Of Animals (sum)`, na.rm = TRUE)) %>% 
  spread(Fishery, Harvest, fill = 0))
```

## Sample sizes

Final samples sizes for all Quadrant x Period. The original plan was to run ~200 fish for Late Winter NO, NI, and SI, however, I had to subsampled down in order to get the samples analyzed proportional to harvest by stat week.
```{r winter_n}
summer_2018_sample_sizes %>% 
  separate(silly, into = c("Fishery", "Year"), sep = "_") %>% 
  select(Fishery, genotyped, missing, duplicate, final)
```

## Stock composition
For each Quadrant and Period there will be a table showing stock composition results for all major stocks (i.e. those contributing > 5% to harvest).  
**Note** Late Winter NO, NI, and SI did not have as many samples run as planned (see above), thus we will need to discuss how many reporting groups we ultimately include. Take the results presented here with a grain of salt.

### Early Winter - Northern Outside (171)
What are the major stocks contributing to these mixtures (mean > 5%)?
```{r winter_stock_comp_table_EWintNO}
winter_2018_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "EWint" & quadrant == "NO") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

```{r winter_troll_figures_EWintNO, out.width="100%"}
winter_2018_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "EWint" & quadrant == "NO") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Early Winter Troll AY 2018: Northern Outside 171")
```

### Early Winter - All Quadrants
What are the major stocks contributing to these mixtures (mean > 5%)?
```{r winter_stock_comp_table_EWintAllQuad}
winter_2018_33RG_stratified_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "EWint") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

```{r winter_troll_figures_EWintAllQuad, out.width="100%"}
winter_2018_33RG_stratified_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "EWint") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Early Winter Troll AY 2018: All Quad")
```

### Late Winter - Northern Outside (171), Northern Inside (173), and Southern Inside (174)
What are the major stocks contributing to these mixtures (mean > 5%)?  
**Note** the sample sizes for these mixtures are <200 fish, so normally we would not report to this level of detail.
```{r winter_stock_comp_table_LWintNONISI}
winter_2018_33RG_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "LWint" & quadrant != "SO") %>% 
  mutate(quadrant = factor(x = quadrant, levels = c("NO", "SO", "NI", "SI"))) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

```{r winter_troll_figures_LWintNONISI, out.width="100%", out.height="200%"}
winter_2018_33RG_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "LWint" & quadrant != "SO") %>% 
  mutate(quadrant = factor(x = quadrant, levels = c("NO", "SO", "NI", "SI"))) %>%   ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Late Winter Troll AY 2018: Quadrant") +
  facet_grid(quadrant ~ .)
```

### Late Winter - All Quadrants
What are the major stocks contributing to these mixtures (mean > 5%)?
```{r winter_stock_comp_table_LWintAllQuad}
winter_2018_33RG_stratified_estimates.tdy %>% 
  mutate(value = value * 100) %>% 
  spread(estimator, value) %>% 
  filter(mean > 5 & fishery == "LWint") %>% 
  mutate_if(is.numeric, round, 1) %>% 
  arrange(quadrant, fishery, desc(mean)) %>% 
  select(fishery, quadrant, group, mean, sd, `5%`, `95%`)
```

```{r winter_troll_figures_LWintAllQuad, out.width="100%"}
winter_2018_33RG_stratified_estimates.tdy %>% 
  spread(estimator, value) %>% 
  filter(fishery == "LWint") %>% 
  ggplot(aes(x = group, y = mean * 100)) +
  geom_col(fill = "lightblue") +
  geom_errorbar(aes(ymin = `5%` * 100, ymax = `95%` * 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.3)) +
  ylim(0, 100) +
  ylab("Stock Composition (%)") +
  xlab("Reporting Group") +
  ggtitle("Late Winter Troll AY 2018: All Quad")
```
