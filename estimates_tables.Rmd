---
title: "Estimates Tables for Report"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup}
source("~/../R/Functions.GCL.R")
library(tidyverse)
library(lubridate)
library(xlsx)
load_objects("../Objects/")
```

# Purpose
The purpose of this short notebook is to generate publication ready tables for the 2018 Troll + Sport Chinook GSI report

# 8RG Summary Tables

## Estimates objects

Get objects
```{r}
(
  SEAK18estimatesobjects <-
    list.files(
      path = "../Estimates objects",
      recursive = FALSE,
      pattern = "_8RG"
    )
)
```

Load objects
```{r}
load_objects(path = "../Estimates objects", pattern = "Troll2018_8RG")
```

Verify
```{r}
names(Troll2018_8RG_EstimatesStats)
```

Add in the annual stratified estimates
```{r}
Troll2018_8RG_EstimatesStats <- c(Troll2018_8RG_EstimatesStats, list("Annual_2018" = AllYearTroll2018_8RG_StratifiedEstimatesStats))
```

## Check GR

```{r}
any(sapply(Troll2018_8RG_EstimatesStats, function(mix) {any(mix[, "GR"] > 1.2)}))
```

## Reformat estimates stats

```{r}
(
  Troll2018_8RG_EstimatesStats_Formatted <-
    sapply(Troll2018_8RG_EstimatesStats, function(yr) {
      matrix(
        data = yr[, 1:5],
        nrow = 8,
        ncol = 5,
        dimnames = list(GroupNames8Pub, c("Mean", "SD", "Median", "5%", "95%"))
      )
    }, simplify = FALSE)
)
```

Save
```{r}
save_objects(objects = "Troll2018_8RG_EstimatesStats_Formatted", path = "../Estimates objects/")
```

```{r}
names(Troll2018_8RG_EstimatesStats_Formatted)
```

Rename
```{r}
(Troll2018_8RG_PubNames <-
   setNames(
     object = c(
       "Early Winter Northern Outside Quadrant",
       "Early Winter All Quadrants",
       "Late Winter Northern Outside Quadrant",
       "Late Winter All Quadrants",
       "Spring Northern Outside Quadrant",
       "Spring Southern Inside Quadrant",
       "Spring All Quadrants",
       "Summer Retention 1 Northern Outside Quadrant",
       "Summer Retention 1 All Quadrants",
       "Summer Retention 2 Northern Outside Quadrant",
       "Summer Retention 2 All Quadrants",
       "AY 2018 Annual"
     ),
     nm = names(Troll2018_8RG_EstimatesStats_Formatted)
   ))

save_objects(objects = "Troll2018_8RG_PubNames", path = "../Objects")
```

## Sample Sizes

```{r}
objects(pattern = "sample")
```
Get sample sizes
```{r}
(
  sample_sizes_2018 <-
    dplyr::bind_rows(
      winter_2018_sample_sizes,
      spring_2018_sample_sizes,
      summer_2018_sample_sizes,
      sport_2018_sample_sizes
    )
)
```

Match sample sizes up to stratified estimates
```{r}
(Troll2018_8RG_MixNames <- setNames(
  object = list(
    "EWintNO_2018",
    winter_2018_mixnames[1:4],
    "LWintNO_2018",
    winter_2018_mixnames[5:8],
    spring_2018_mixnames[c(1, 8, 9, 5, 10, 2)],
    spring_2018_mixnames[c(3, 6)],
    spring_2018_mixnames[c(3, 6, 4, 7, 1, 8, 9, 5, 10, 2)],
    "SummerRet1NO_2018",
    summer_2018_mixnames[1:4],
    "SummerRet2NO_2018",
    summer_2018_mixnames[5:8],
    c(winter_2018_mixnames, spring_2018_mixnames, summer_2018_mixnames)
  ),
  nm = names(Troll2018_8RG_EstimatesStats_Formatted)
))

save_objects(objects = "Troll2018_8RG_MixNames", path = "../Objects")
```

Get sample sizes
```{r}
(Troll2018_8RG_SampleSizes <-
   sapply(Troll2018_8RG_MixNames, function(mix) {
     sample_sizes_2018 %>%
       filter(silly %in% mix) %>%
       summarise(n = sum(final)) %>% 
       pull(n)
   }))
```

## Create fully formatted spreadsheat

```{r}
EstimatesStats <- Troll2018_8RG_EstimatesStats_Formatted
SampSizes <- Troll2018_8RG_SampleSizes
PubNames <- Troll2018_8RG_PubNames
```

```{r}
for(mix in names(EstimatesStats)) {
  TableX <- matrix(data = "",
                   nrow = 11,
                   ncol = 7)
  TableX[1, 3] <- paste(PubNames[mix], " (n=", SampSizes[mix], ")")
  TableX[2, 6] <- "90% CI"
  TableX[3, 2:7] <-
    c("Reporting Group", colnames(EstimatesStats[[mix]]))
  TableX[4:11, 1] <- 1:8
  TableX[4:11, 2] <- rownames(EstimatesStats[[mix]])
  TableX[4:11, 3:7] <-
    formatC(x = EstimatesStats[[mix]],
            digits = 3,
            format = "f")
  
  xlsx::write.xlsx(
    x = TableX,
    file = "../Estimates tables/Troll2018_8RG_StratifiedEstimatesStats_FormattedPretty.xlsx",
    col.names = FALSE,
    row.names = FALSE,
    sheetName = paste(mix, " Troll 8 Driver"),
    append = TRUE
  )
  
}
```



